% aidisclose.sty
% 
% Copyright (C) 2025-26 by João M. Lourenço <joao.lourenco@fct.unl.pt>
% Modified based on user requirements.
%
% This file may be distributed and/or modified under the conditions of
% the LaTeX Project Public License, either version 1.3c of this license
% or (at your option) any later version.
\def\aidversion{1.8.2}
%
\NeedsTeXFormat{LaTeX2e}[2020/10/01]
\ProvidesExplPackage {aidisclose} {2026/01/21} {\aidversion} 
  {Utilities for Generative AI disclosure checklist and statements}

% =========================================================
% 0) OPTIONS & DEPENDENCIES
% =========================================================
\bool_new:N \g__aid_autobib_bool
\bool_set_true:N \g__aid_autobib_bool
\bool_new:N \g__aid_nocite_bool
\bool_set_true:N \g__aid_nocite_bool

\DeclareKeys[aidisclose]
  {
    autobib .bool_set:N = \g__aid_autobib_bool,
    autobib .initial:n  = true,
    nocite .bool_set:N = \g__aid_nocite_bool,
    nocite .initial:n  = true,
  }
\ProcessKeyOptions[aidisclose]

\ifcsname checkmark\endcsname\else
  \RequirePackage{amssymb}   % for \checkmark
\fi
\RequirePackage{multicol}    % for multi-column layout
\RequirePackage{relsize}     % for relative font sizing
\RequirePackage{xcolor}      % for color customization

% =========================================================
% 1) VARIABLE DEFINITIONS (Strings)
% =========================================================

\str_new:N \g__aid_bibfile_str
\tl_new:N  \g__aid_str_tools_used_tl
\tl_new:N  \g__aid_str_none_used_tl
\tl_new:N  \g__aid_str_declares_tl
\tl_new:N  \g__aid_str_declare_tl
\tl_new:N  \g__aid_str_acknowledges_tl
\tl_new:N  \g__aid_str_acknowledge_tl
\tl_new:N  \g__aid_str_and_tl
\tl_new:N  \g__aid_str_preamble_tl
\tl_new:N  \g__aid_str_footnote_tl
\tl_new:N  \g__aid_str_comment_label_tl
\tl_new:N  \g__aid_str_comment_star_label_tl
\tl_new:N  \g__aid_str_title_long_tl
\tl_new:N  \g__aid_str_title_short_tl

% --- Section Pre/Post Strings ---
\tl_new:N  \g__aid_str_pre_tools_tl
\tl_new:N  \g__aid_str_post_tools_tl
\tl_new:N  \g__aid_str_pre_taxonomy_tl
\tl_new:N  \g__aid_str_post_taxonomy_tl
\tl_new:N  \g__aid_str_pre_comments_tl
\tl_new:N  \g__aid_str_post_comments_tl

% ---------------------------------------------------------
% Group Titles
% ---------------------------------------------------------
\tl_new:N \g__aid_str_grp_conc_tl
\tl_new:N \g__aid_str_grp_lit_tl
\tl_new:N \g__aid_str_grp_meth_tl
\tl_new:N \g__aid_str_grp_soft_tl
\tl_new:N \g__aid_str_grp_data_tl
\tl_new:N \g__aid_str_grp_vis_tl
\tl_new:N \g__aid_str_grp_write_tl
\tl_new:N \g__aid_str_grp_eth_tl
\tl_new:N \g__aid_str_grp_sup_tl

% ---------------------------------------------------------
% 1. Conceptualization
% ---------------------------------------------------------
\tl_new:N \g__aid_str_c_idea_tl
\tl_new:N \g__aid_str_c_obj_tl
\tl_new:N \g__aid_str_c_rq_tl
\tl_new:N \g__aid_str_c_feas_tl
\tl_new:N \g__aid_str_c_pre_tl
\tl_new:N \g__aid_str_c_sim_tl

% ---------------------------------------------------------
% 2. Literature Review
% ---------------------------------------------------------
\tl_new:N \g__aid_str_l_srch_tl
\tl_new:N \g__aid_str_l_sum_tl
\tl_new:N \g__aid_str_l_map_tl
\tl_new:N \g__aid_str_l_pat_tl
\tl_new:N \g__aid_str_l_gaps_tl
\tl_new:N \g__aid_str_l_trans_tl

% ---------------------------------------------------------
% 3. Methodology
% ---------------------------------------------------------
\tl_new:N \g__aid_str_m_des_tl
\tl_new:N \g__aid_str_m_proto_tl
\tl_new:N \g__aid_str_m_meth_tl

% ---------------------------------------------------------
% 4. Software Development and Automation
% ---------------------------------------------------------
\tl_new:N \g__aid_str_s_gen_tl
\tl_new:N \g__aid_str_s_opt_tl
\tl_new:N \g__aid_str_s_debug_tl
\tl_new:N \g__aid_str_s_auto_tl
\tl_new:N \g__aid_str_s_algs_tl
\tl_new:N \g__aid_str_s_doc_tl

% ---------------------------------------------------------
% 5. Data Management
% ---------------------------------------------------------
\tl_new:N \g__aid_str_d_coll_tl
\tl_new:N \g__aid_str_d_val_tl
\tl_new:N \g__aid_str_d_cln_tl
\tl_new:N \g__aid_str_d_cur_tl
\tl_new:N \g__aid_str_d_anl_tl
\tl_new:N \g__aid_str_d_viz_tl
\tl_new:N \g__aid_str_d_rep_tl
\tl_new:N \g__aid_str_d_lbl_tl
\tl_new:N \g__aid_str_d_syn_tl
\tl_new:N \g__aid_str_d_anon_tl
\tl_new:N \g__aid_str_d_trans_tl

% ---------------------------------------------------------
% 6. Visuals and Multimedia
% ---------------------------------------------------------
\tl_new:N \g__aid_str_v_gen_tl
\tl_new:N \g__aid_str_v_edit_tl
\tl_new:N \g__aid_str_v_chart_tl

% ---------------------------------------------------------
% 7. Writing and Editing
% ---------------------------------------------------------
\tl_new:N \g__aid_str_w_draft_tl
\tl_new:N \g__aid_str_w_poly_tl
\tl_new:N \g__aid_str_w_sum_tl
\tl_new:N \g__aid_str_w_con_tl
\tl_new:N \g__aid_str_w_tone_tl
\tl_new:N \g__aid_str_w_tra_tl
\tl_new:N \g__aid_str_w_ref_tl
\tl_new:N \g__aid_str_w_prs_tl
\tl_new:N \g__aid_str_w_title_tl

% ---------------------------------------------------------
% 8. Ethics Review
% ---------------------------------------------------------
\tl_new:N \g__aid_str_e_bias_tl
\tl_new:N \g__aid_str_e_risk_tl
\tl_new:N \g__aid_str_e_comp_tl
\tl_new:N \g__aid_str_e_conf_tl

% ---------------------------------------------------------
% 9. Critique and Feedback
% ---------------------------------------------------------
\tl_new:N \g__aid_str_sup_qa_tl
\tl_new:N \g__aid_str_sup_trd_tl
\tl_new:N \g__aid_str_sup_lim_tl
\tl_new:N \g__aid_str_sup_rec_tl
\tl_new:N \g__aid_str_sup_pub_tl

% --- Helper Variables ---
\dim_new:N \l__aid_fboxsep_dim
\dim_new:N \l__aid_boxwd_dim
\dim_new:N \l__aid_labelsep_dim
\dim_set:Nn \l__aid_fboxsep_dim { 1.2pt }
\dim_set:Nn \l__aid_labelsep_dim { 0.9em }

\seq_new:N \g__aid_active_keys_seq
\seq_new:N \l__aid_tools_seq
\seq_new:N \g__aid_order_seq  % Sequence to store part order

\tl_new:N  \l__aid_temp_tl
\tl_new:N  \g__aid_comments_tl
\tl_new:N  \g__aid_taxonomy_tl
\tl_new:N  \g__aid_title_long_tl
\tl_new:N  \g__aid_title_short_tl
\tl_new:N  \g__aid_section_cmd_tl
\tl_new:N  \g__aid_tools_sentence_tl
\tl_new:N  \g__aid_fontsize_tl
\tl_new:N  \g__aid_checkmark_symbol_tl
\int_new:N   \g__aid_authors_int
\int_new:N   \g__aid_comment_int
\clist_new:N \g__aid_authors_clist

% Temp vars for substitution
\tl_new:N \l__aid_author_names_tl
\tl_new:N \l__aid_declares_verb_tl
\tl_new:N \l__aid_acknowledges_verb_tl
\tl_new:N \l__aid_working_preamble_tl

% Color Variables
\tl_new:N \g__aid_color_used_tl
\tl_new:N \g__aid_color_unused_tl
\tl_new:N \g__aid_color_checkmark_tl
\tl_new:N \g__aid_color_box_used_tl
\tl_new:N \g__aid_color_box_unused_tl

\str_set:Nn \g__aid_bibfile_str { aidisclose.bib }

% =========================================================
% 2) KEYS DEFINITIONS
% =========================================================

\NewDocumentCommand \AIDstrings { m }
  {
    \keys_set:nn { aidisclose / strings } { #1 }
  }

\keys_define:nn { aidisclose / strings }
  {
% ---------------------------------------------------------
% General Strings
% ---------------------------------------------------------
    tools_used    .tl_set:N = \g__aid_str_tools_used_tl,
    none_used     .tl_set:N = \g__aid_str_none_used_tl,
    declares      .tl_set:N = \g__aid_str_declares_tl,
    declare       .tl_set:N = \g__aid_str_declare_tl,
    acknowledges  .tl_set:N = \g__aid_str_acknowledges_tl,
    acknowledge   .tl_set:N = \g__aid_str_acknowledge_tl,
    and           .tl_set:N = \g__aid_str_and_tl,
    preamble      .tl_set:N = \g__aid_str_preamble_tl,
    footnote      .tl_set:N = \g__aid_str_footnote_tl,
    comment_label .tl_set:N = \g__aid_str_comment_label_tl,
    comment_star  .tl_set:N = \g__aid_str_comment_star_label_tl,
    title_long    .tl_set:N = \g__aid_str_title_long_tl,
    title_short   .tl_set:N = \g__aid_str_title_short_tl,

% ---------------------------------------------------------
% Pre/Post Strings
% ---------------------------------------------------------
    pre_tools     .tl_set:N = \g__aid_str_pre_tools_tl,
    post_tools    .tl_set:N = \g__aid_str_post_tools_tl,
    pre_taxonomy  .tl_set:N = \g__aid_str_pre_taxonomy_tl,
    post_taxonomy .tl_set:N = \g__aid_str_post_taxonomy_tl,
    pre_comments  .tl_set:N = \g__aid_str_pre_comments_tl,
    post_comments .tl_set:N = \g__aid_str_post_comments_tl,
    
% ---------------------------------------------------------
% Group Titles
% ---------------------------------------------------------
    grp_conc      .tl_set:N = \g__aid_str_grp_conc_tl,
    grp_lit       .tl_set:N = \g__aid_str_grp_lit_tl,
    grp_meth      .tl_set:N = \g__aid_str_grp_meth_tl,
    grp_soft      .tl_set:N = \g__aid_str_grp_soft_tl,
    grp_data      .tl_set:N = \g__aid_str_grp_data_tl,
    grp_vis       .tl_set:N = \g__aid_str_grp_vis_tl,
    grp_write     .tl_set:N = \g__aid_str_grp_write_tl,
    grp_eth       .tl_set:N = \g__aid_str_grp_eth_tl,
    grp_sup       .tl_set:N = \g__aid_str_grp_sup_tl,

% ---------------------------------------------------------
% 1. Conceptualization
% ---------------------------------------------------------
    c_idea      .tl_set:N = \g__aid_str_c_idea_tl,
    c_obj       .tl_set:N = \g__aid_str_c_obj_tl,
    c_rq        .tl_set:N = \g__aid_str_c_rq_tl,
    c_feas      .tl_set:N = \g__aid_str_c_feas_tl,
    c_pre       .tl_set:N = \g__aid_str_c_pre_tl,
    c_sim       .tl_set:N = \g__aid_str_c_sim_tl,

% ---------------------------------------------------------
% 2. Literature Review
% ---------------------------------------------------------
    l_srch      .tl_set:N = \g__aid_str_l_srch_tl,
    l_sum       .tl_set:N = \g__aid_str_l_sum_tl,
    l_map       .tl_set:N = \g__aid_str_l_map_tl,
    l_pat       .tl_set:N = \g__aid_str_l_pat_tl,
    l_gaps      .tl_set:N = \g__aid_str_l_gaps_tl,
    l_trans     .tl_set:N = \g__aid_str_l_trans_tl,

% ---------------------------------------------------------
% 3. Methodology
% ---------------------------------------------------------
    m_des       .tl_set:N = \g__aid_str_m_des_tl,
    m_proto     .tl_set:N = \g__aid_str_m_proto_tl,
    m_meth      .tl_set:N = \g__aid_str_m_meth_tl,

% ---------------------------------------------------------
% 4. Software Development and Automation
% ---------------------------------------------------------
    s_gen       .tl_set:N = \g__aid_str_s_gen_tl,
    s_opt       .tl_set:N = \g__aid_str_s_opt_tl,
    s_debug     .tl_set:N = \g__aid_str_s_debug_tl,
    s_auto      .tl_set:N = \g__aid_str_s_auto_tl,
    s_algs      .tl_set:N = \g__aid_str_s_algs_tl,
    s_doc       .tl_set:N = \g__aid_str_s_doc_tl,

% ---------------------------------------------------------
% 5. Data Management
% ---------------------------------------------------------
    d_coll      .tl_set:N = \g__aid_str_d_coll_tl,
    d_val       .tl_set:N = \g__aid_str_d_val_tl,
    d_cln       .tl_set:N = \g__aid_str_d_cln_tl,
    d_cur       .tl_set:N = \g__aid_str_d_cur_tl,
    d_anl       .tl_set:N = \g__aid_str_d_anl_tl,
    d_viz       .tl_set:N = \g__aid_str_d_viz_tl,
    d_rep       .tl_set:N = \g__aid_str_d_rep_tl,
    d_lbl       .tl_set:N = \g__aid_str_d_lbl_tl,
    d_syn       .tl_set:N = \g__aid_str_d_syn_tl,
    d_anon      .tl_set:N = \g__aid_str_d_anon_tl,
    d_trans     .tl_set:N = \g__aid_str_d_trans_tl,

% ---------------------------------------------------------
% 6. Visuals and Multimedia
% ---------------------------------------------------------
    v_gen       .tl_set:N = \g__aid_str_v_gen_tl,
    v_edit      .tl_set:N = \g__aid_str_v_edit_tl,
    v_chart     .tl_set:N = \g__aid_str_v_chart_tl,

% ---------------------------------------------------------
% 7. Writing and Editing
% ---------------------------------------------------------
    w_draft     .tl_set:N = \g__aid_str_w_draft_tl,
    w_poly      .tl_set:N = \g__aid_str_w_poly_tl,
    w_sum       .tl_set:N = \g__aid_str_w_sum_tl,
    w_con       .tl_set:N = \g__aid_str_w_con_tl,
    w_tone      .tl_set:N = \g__aid_str_w_tone_tl,
    w_tra       .tl_set:N = \g__aid_str_w_tra_tl,
    w_ref       .tl_set:N = \g__aid_str_w_ref_tl,
    w_prs       .tl_set:N = \g__aid_str_w_prs_tl,
    w_title     .tl_set:N = \g__aid_str_w_title_tl,

% ---------------------------------------------------------
% 8. Ethics Review
% ---------------------------------------------------------
    e_bias      .tl_set:N = \g__aid_str_e_bias_tl,
    e_risk      .tl_set:N = \g__aid_str_e_risk_tl,
    e_comp      .tl_set:N = \g__aid_str_e_comp_tl,
    e_conf      .tl_set:N = \g__aid_str_e_conf_tl,

% ---------------------------------------------------------
% 9. Critique and Feedback
% ---------------------------------------------------------
    sup_qa      .tl_set:N = \g__aid_str_sup_qa_tl,
    sup_trd     .tl_set:N = \g__aid_str_sup_trd_tl,
    sup_lim     .tl_set:N = \g__aid_str_sup_lim_tl,
    sup_rec     .tl_set:N = \g__aid_str_sup_rec_tl,
    sup_pub     .tl_set:N = \g__aid_str_sup_pub_tl,
  }

% =========================================================
% 3) LANGUAGE HANDLING
% =========================================================

\prop_new:N \g__aid_lang_map_prop
\prop_gset_from_keyval:Nn \g__aid_lang_map_prop
  {
    english    = en,
    american   = en,
    british    = en,
    canadian   = en,
    australian = en,
    newzealand = en,
    UKenglish  = en,
    USenglish  = en,
    
    portuguese = pt,
    brazilian  = pt,
    portuges   = pt,
    
    catalan    = cat,
    czech      = cz,
    german     = de,
    ngerman    = de,
    austrian   = de,
    naustrian  = de,
    danish     = dk,
    spanish    = es,
    french     = fr,
    acadian    = fr,
    canadien   = fr,
    greek      = gr,
    polutonikogreek = gr,
    italian    = it,
    dutch      = nl,
    polish     = pl,
    slovak     = sk,
    ukrainian  = uk
  }


\cs_new_protected:Nn \__aid_load_lang_file:n
  {
    % 1. Try specific language in current/root directory
    \file_if_exist:nTF { aidisclose-#1.ldf }
      { \file_input:n { aidisclose-#1.ldf } }
      {
        % 2. Try specific language in 'langdef/' folder
        \file_if_exist:nTF { langdef/aidisclose-#1.ldf }
          { \file_input:n { langdef/aidisclose-#1.ldf } }
          {
            % 3. Fallback: English in current/root directory
            \file_if_exist:nTF { aidisclose-en.ldf }
              { \file_input:n { aidisclose-en.ldf } }
              { 
                % 4. Fallback: English in 'langdef/'
                \file_if_exist:nTF { langdef/aidisclose-en.ldf }
                  { \file_input:n { langdef/aidisclose-en.ldf } }
                  { 
                    % ERROR: No files found
                    \msg_error:nnn { aidisclose } { lang-not-found } { #1 }
                  }
              }
          }
      }
  }

% 1. Define the error message
\msg_new:nnnn { aidisclose } { lang-not-found }
  { Language~definition~file~for~'#1'~could~not~be~found. }
  {
    The~package~tried~to~load~'aidisclose-#1.ldf'~and~the~fallback~
    'aidisclose-en.ldf'~in~both~the~current~directory~and~the~
    'langdef/'~subdirectory,~but~none~were~found.
  }

\cs_new_protected:Nn \__aid_detect_and_load_language:
  {
    \bool_set_false:N \l_tmpa_bool
    
    \ifcsname languagename\endcsname
      \prop_get:NxNTF \g__aid_lang_map_prop { \languagename } \l__suffix_tl
        { 
          \__aid_load_lang_file:n { \l__suffix_tl }
          \bool_set_true:N \l_tmpa_bool
        }
        {}
    \fi
    
    \bool_if:NF \l_tmpa_bool
      {
        \__aid_load_lang_file:n { en }
      }
  }

% =========================================================
% 4) INTERNAL UTILITIES & TAXONOMY
% =========================================================

% Detect the Engine Name (LuaLaTeX, XeLaTeX, pdfLaTeX)
\NewDocumentCommand \AIDengineName {}
  {
    \sys_if_engine_luatex:TF { Lua\LaTeX }
      {
        \sys_if_engine_xetex:TF { Xe\LaTeX }
          {
            \sys_if_engine_pdftex:TF { pdf\LaTeX } { \LaTeX }
          }
      }
      \CiteLaTeX
  }

% Print Package Name with Link
\NewDocumentCommand \AIDpackageName {}
  {
    \group_begin:
      \cs_if_exist:NTF \hypersetup
        { \hypersetup{allcolors=black} }
        {}
      \cs_if_exist:NTF \href
        { \href{https://ctan.org/pkg/aidisclose}{\texttt{aidisclose}} }
        { \texttt{aidisclose} }
    \group_end:
  }

\cs_new_protected:Npn \__aid_print_checked_box:
  {
    \group_begin:
    \dim_set:Nn \fboxsep { \l__aid_fboxsep_dim }
    \color{ \g__aid_color_box_used_tl }
    \fbox { 
      \color{ \g__aid_color_checkmark_tl }
      \tl_use:N \g__aid_checkmark_symbol_tl 
    }
    \group_end:
  }

\cs_new_protected:Npn \__aid_print_empty_box:
  {
    \group_begin:
    \dim_set:Nn \fboxsep { \l__aid_fboxsep_dim }
    \color{ \g__aid_color_box_unused_tl }
    \fbox { \phantom { \tl_use:N \g__aid_checkmark_symbol_tl } }
    \group_end:
  }

\cs_new_protected:Npn \__aid_checkbox_for:n #1
  {
    \seq_if_in:NxTF \g__aid_active_keys_seq { \tl_to_str:n { #1 } }
      { \__aid_print_checked_box: }
      { \__aid_print_empty_box: }
  }

% Updated to use substituted string
\cs_new_protected:Npn \__aid_print_preamble:
  {
    \tl_use:N \l__aid_working_preamble_tl
    \bool_if:NF \g__aid_nocite_bool
      {
        \footnote{
          \tl_use:N \g__aid_str_footnote_tl 
          \nobreakspace \cite{Lourenco:2025:aidisclose}.
        }
      }
  }

\cs_new_protected:Npn \CiteLaTeX
  {
    \bool_if:NF \g__aid_nocite_bool
      {
        \nobreakspace  \cite{latex-project}
      }
  }

\cs_new_protected:Npn \CiteAIDDeT
  {
    \bool_if:NF \g__aid_nocite_bool
      {
        \nobreakspace  \cite{Suchikova:2025:AIDDeT}
      }
  }


% CHECKLIST ENVIRONMENT (Replaces enumitem)
\cs_new_protected:Nn \_aid_label:
  {
    \hbox_to_wd:nn { 1em } { \hss \framebox[0.8em]{\vphantom{t}} \hss }
  }

\NewDocumentEnvironment{aidlist} { }
  {
    % Start a standard list
    \list { \_aid_label: }
      {
        \setlength { \topsep }      { 0pt }
        \setlength { \partopsep }   { 0pt }
        \setlength { \itemsep }     { 0pt }
        \setlength { \parsep }      { 5pt }
        \setlength { \leftmargin }  { 1.5em }
        \setlength { \labelwidth }  { 1em }
        \setlength { \labelsep }    { 0.5em }
        \setlength { \listparindent } { 0pt }
      }
  }
  {
    \endlist
  }
  
  
% --- Taxonomy Data Structure ---
\tl_gset:Nn \g__aid_taxonomy_tl {
  % --- 1. Conceptualization ---
  \TGroup{\tl_use:N \g__aid_str_grp_conc_tl}{
    \TItem{c_idea}   {\tl_use:N \g__aid_str_c_idea_tl}
    \TItem{c_obj}    {\tl_use:N \g__aid_str_c_obj_tl}
    \TItem{c_rq}     {\tl_use:N \g__aid_str_c_rq_tl}
    \TItem{c_feas}   {\tl_use:N \g__aid_str_c_feas_tl}
    \TItem{c_pre}    {\tl_use:N \g__aid_str_c_pre_tl}
    \TItem{c_sim}    {\tl_use:N \g__aid_str_c_sim_tl}
  }
  % --- 2. Literature Review ---
  \TGroup{\tl_use:N \g__aid_str_grp_lit_tl}{
    \TItem{l_srch}   {\tl_use:N \g__aid_str_l_srch_tl}
    \TItem{l_sum}    {\tl_use:N \g__aid_str_l_sum_tl}
    \TItem{l_map}    {\tl_use:N \g__aid_str_l_map_tl}
    \TItem{l_pat}    {\tl_use:N \g__aid_str_l_pat_tl}
    \TItem{l_gaps}   {\tl_use:N \g__aid_str_l_gaps_tl}
    \TItem{l_trans}  {\tl_use:N \g__aid_str_l_trans_tl}
  }
  % --- 3. Methodology ---
  \TGroup{\tl_use:N \g__aid_str_grp_meth_tl}{
    \TItem{m_des}    {\tl_use:N \g__aid_str_m_des_tl}
    \TItem{m_proto}  {\tl_use:N \g__aid_str_m_proto_tl}
    \TItem{m_meth}   {\tl_use:N \g__aid_str_m_meth_tl}
  }
  % --- 4. Software Development ---
  \TGroup{\tl_use:N \g__aid_str_grp_soft_tl}{
    \TItem{s_gen}    {\tl_use:N \g__aid_str_s_gen_tl}
    \TItem{s_opt}    {\tl_use:N \g__aid_str_s_opt_tl}
    \TItem{s_debug}  {\tl_use:N \g__aid_str_s_debug_tl}
    \TItem{s_auto}   {\tl_use:N \g__aid_str_s_auto_tl}
    \TItem{s_algs}   {\tl_use:N \g__aid_str_s_algs_tl}
    \TItem{s_doc}    {\tl_use:N \g__aid_str_s_doc_tl} 
  }
  % --- 5. Data Management ---
  \TGroup{\tl_use:N \g__aid_str_grp_data_tl}{
    \TItem{d_coll}    {\tl_use:N \g__aid_str_d_coll_tl}
    \TItem{d_val}     {\tl_use:N \g__aid_str_d_val_tl}
    \TItem{d_cln}     {\tl_use:N \g__aid_str_d_cln_tl}
    \TItem{d_cur}     {\tl_use:N \g__aid_str_d_cur_tl}
    \TItem{d_anl}     {\tl_use:N \g__aid_str_d_anl_tl}
    \TItem{d_viz}     {\tl_use:N \g__aid_str_d_viz_tl}
    \TItem{d_rep}     {\tl_use:N \g__aid_str_d_rep_tl}
    \TItem{d_lbl}     {\tl_use:N \g__aid_str_d_lbl_tl} 
    \TItem{d_syn}     {\tl_use:N \g__aid_str_d_syn_tl} 
    \TItem{d_anon}    {\tl_use:N \g__aid_str_d_anon_tl} 
    \TItem{d_trans}   {\tl_use:N \g__aid_str_d_trans_tl}
  }
  % --- 6. Visuals and Multimedia ---
  \TGroup{\tl_use:N \g__aid_str_grp_vis_tl}{
    \TItem{v_gen}     {\tl_use:N \g__aid_str_v_gen_tl}
    \TItem{v_edit}    {\tl_use:N \g__aid_str_v_edit_tl}
    \TItem{v_chart}   {\tl_use:N \g__aid_str_v_chart_tl}
  }
  % --- 7. Writing and Editing ---
  \TGroup{\tl_use:N \g__aid_str_grp_write_tl}{
    \TItem{w_draft}   {\tl_use:N \g__aid_str_w_draft_tl}
    \TItem{w_poly}    {\tl_use:N \g__aid_str_w_poly_tl}
    \TItem{w_title}   {\tl_use:N \g__aid_str_w_title_tl}
    \TItem{w_sum}     {\tl_use:N \g__aid_str_w_sum_tl}
    \TItem{w_con}     {\tl_use:N \g__aid_str_w_con_tl}
    \TItem{w_ref}     {\tl_use:N \g__aid_str_w_ref_tl}
    \TItem{w_tone}    {\tl_use:N \g__aid_str_w_tone_tl}
    \TItem{w_tra}     {\tl_use:N \g__aid_str_w_tra_tl}
    \TItem{w_prs}     {\tl_use:N \g__aid_str_w_prs_tl}
  }
  % --- 8. Ethics Review ---
  \TGroup{\tl_use:N \g__aid_str_grp_eth_tl}{
    \TItem{e_bias}    {\tl_use:N \g__aid_str_e_bias_tl}
    \TItem{e_risk}    {\tl_use:N \g__aid_str_e_risk_tl}
    \TItem{e_comp}    {\tl_use:N \g__aid_str_e_comp_tl}
    \TItem{e_conf}    {\tl_use:N \g__aid_str_e_conf_tl}
  }
  % --- 9. Critique and Feedback ---
  \TGroup{\tl_use:N \g__aid_str_grp_sup_tl}{
    \TItem{sup_qa}    {\tl_use:N \g__aid_str_sup_qa_tl}
    \TItem{sup_trd}   {\tl_use:N \g__aid_str_sup_trd_tl}
    \TItem{sup_lim}   {\tl_use:N \g__aid_str_sup_lim_tl}
    \TItem{sup_rec}   {\tl_use:N \g__aid_str_sup_rec_tl}
    \TItem{sup_pub}   {\tl_use:N \g__aid_str_sup_pub_tl}
  }
}

% =========================================================
% 5) USER CONFIGURATION COMMANDS
% =========================================================

\NewDocumentCommand \AIDcheckmarkSymbol { m }
  {
    \tl_gset:Nn \g__aid_checkmark_symbol_tl { #1 }
    \hbox_set:Nn \l_tmpa_box { \fbox { #1 } }
    \dim_set:Nn \l__aid_boxwd_dim { \box_wd:N \l_tmpa_box }
  }

\cs_generate_variant:Nn \tl_replace_all:Nnn { Nxx }
\NewDocumentCommand \AIDactivate { m }
  {
    % 1. Force input to be a plain string immediately.
    %    This converts "punctuation-colon" to "string-colon", fixing the mismatch.
    \tl_set:Nx \l__aid_temp_tl { \tl_to_str:n { #1 } }

    % 2. Trim surrounding spaces
    \tl_trim_spaces:N \l__aid_temp_tl

    % 3. Replace ":" with "_" safely.
    %    We use \exp_args:Nnxx to ensure we search for a "string-colon"
    %    and replace it with a "string-underscore".
    \tl_replace_all:Nxx \l__aid_temp_tl
      { \tl_to_str:n { : } }
      { \tl_to_str:n { _ } }

    % 4. Add the sanitized key to the active list
    \seq_gput_right:No \g__aid_active_keys_seq { \l__aid_temp_tl }
  }

\NewDocumentCommand \AIDtoolsUsed { m }
  {
    \tl_if_blank:nTF { #1 }
      { \tl_gset_eq:NN \g__aid_tools_sentence_tl \g__aid_str_none_used_tl }
      {
        \seq_set_split:Nnn \l__aid_tools_seq { , } { #1 }
        \seq_set_map:NNn \l__aid_tools_seq \l__aid_tools_seq { \tl_trim_spaces:n {##1} }
        \seq_remove_all:Nn \l__aid_tools_seq { }
        \tl_gset:Nx \g__aid_tools_sentence_tl
          {
            \seq_use:Nnnn \l__aid_tools_seq 
              { \ \tl_use:N \g__aid_str_and_tl\  } 
              { ,\  } 
              { ,\ \tl_use:N \g__aid_str_and_tl\  } .
          }
      }
  }

\NewDocumentCommand \AIDchecklistFontSize { m }
  {
    \tl_gset:Nn \g__aid_fontsize_tl { #1 }
  }

\NewDocumentCommand \AIDdiscloseTitle { o m O{} }
  {
    \tl_gset:Nn \g__aid_title_long_tl { #2 }
    \IfNoValueTF { #1 }
      { \tl_gset:Nn \g__aid_title_short_tl { #2 } }
      { \tl_gset:Nn \g__aid_title_short_tl { #1 } }
    \tl_if_blank:nTF { #3 }
      {
        \cs_if_exist:cTF { chapter }
          { \tl_gset:Nn \g__aid_section_cmd_tl { \chapter } }
          { \tl_gset:Nn \g__aid_section_cmd_tl { \section } }
      }
      { \tl_gset:Nn \g__aid_section_cmd_tl { #3 } }
  }

\NewDocumentCommand \AIDdiscloseTitleLong {} 
  { 
    \tl_if_empty:NTF \g__aid_title_long_tl 
      { \tl_use:N \g__aid_str_title_long_tl } 
      { \tl_use:N \g__aid_title_long_tl }
  }

\NewDocumentCommand \AIDdiscloseTitleShort {} 
  { 
     \tl_if_empty:NTF \g__aid_title_short_tl 
      { \tl_use:N \g__aid_str_title_short_tl } 
      { \tl_use:N \g__aid_title_short_tl }
  }
  
% --- Pre/Preamble Setters ---
\NewDocumentCommand \AIDpreamble { m }
  {
    \tl_gset:Nn \g__aid_str_preamble_tl { #1 }
  }

% --- Pre/Post Setters ---
\NewDocumentCommand \AIDpreTools { m }
  { \tl_gset:Nn \g__aid_str_pre_tools_tl { #1 } }
\NewDocumentCommand \AIDpostTools { m }
  { \tl_gset:Nn \g__aid_str_post_tools_tl { #1 } }

\NewDocumentCommand \AIDpreTaxonomy { m }
  { \tl_gset:Nn \g__aid_str_pre_taxonomy_tl { #1 } }
\NewDocumentCommand \AIDpostTaxonomy { m }
  { \tl_gset:Nn \g__aid_str_post_taxonomy_tl { #1 } }

\NewDocumentCommand \AIDpreComments { m }
  { \tl_gset:Nn \g__aid_str_pre_comments_tl { #1 } }
\NewDocumentCommand \AIDpostComments { m }
  { \tl_gset:Nn \g__aid_str_post_comments_tl { #1 } }

% --- Ordering Command ---
\NewDocumentCommand \AIDorder { m }
  {
    \seq_set_from_clist:Nn \g__aid_order_seq { #1 }
  }

% --- Color Configuration Commands ---
\NewDocumentCommand \AIDusedColor { m }
  { \tl_gset:Nn \g__aid_color_used_tl { #1 } }
\NewDocumentCommand \AIDunusedColor { m }
  { \tl_gset:Nn \g__aid_color_unused_tl { #1 } }
\NewDocumentCommand \AIDcheckmarkColor { m }
  { \tl_gset:Nn \g__aid_color_checkmark_tl { #1 } }

% NEW: Separate box color commands
\NewDocumentCommand \AIDboxUsedColor { m }
  { \tl_gset:Nn \g__aid_color_box_used_tl { #1 } }
\NewDocumentCommand \AIDboxUnusedColor { m }
  { \tl_gset:Nn \g__aid_color_box_unused_tl { #1 } }

% Default Configuration
\cs_if_exist:cTF { chapter }
  { \tl_gset:Nn \g__aid_section_cmd_tl { \chapter } }
  { \tl_gset:Nn \g__aid_section_cmd_tl { \section } }

\AIDchecklistFontSize { \smaller }
\AIDcheckmarkSymbol { \checkmark } 
% Set Default Order
\AIDorder { preamble, tools, taxonomy, comments }

% Set Default Colors
\AIDusedColor { black }
\AIDunusedColor { black!50 }
\AIDcheckmarkColor { black }
\AIDboxUsedColor { black }
\AIDboxUnusedColor { black!50 }

% =========================================================
% 6) COMMENT ENVIRONMENTS
% =========================================================
\NewDocumentEnvironment{AIDcomment}{ +b }
  {
    \tl_gput_right:Nn \g__aid_comments_tl
      {
        \int_gincr:N \g__aid_comment_int
        \par \bigskip \noindent
        \textbf{\tl_use:N \g__aid_str_comment_label_tl\ \#\int_use:N \g__aid_comment_int :}\  #1 \par
      }
  } { }

\NewDocumentEnvironment{AIDcomment*}{ +b }
  {
    \tl_gput_right:Nn \g__aid_comments_tl
      {
        \par \bigskip \noindent
        \textbf{\tl_use:N \g__aid_str_comment_star_label_tl :}\  #1 \par
      }
  } { }

% =========================================================
% 7) MAIN RENDERING ENGINE
% =========================================================
\NewDocumentCommand \AIDrenderDeclaration { s O{3} m }
  {
    % 1. Print Title (Header) First
    \IfBooleanF { #1 }
      { 
        \use:c { \cs_to_str:N \g__aid_section_cmd_tl } 
               { 
                 \tl_if_empty:NTF \g__aid_title_long_tl 
                   { \tl_use:N \g__aid_str_title_long_tl }
                   { \tl_use:N \g__aid_title_long_tl }
               }
      }

    % 2. Calculate Author Name List
        \clist_set:Nn \g__aid_authors_clist { #3 }
        \int_set:Nn \g__aid_authors_int { \clist_count:N \g__aid_authors_clist }
    
        \int_compare:nNnTF { \g__aid_authors_int } = { 1 }
          { 
            \tl_set:Nx \l__aid_author_names_tl { #3 }
            % Singular forms
            \tl_set_eq:NN \l__aid_declares_verb_tl \g__aid_str_declares_tl 
            \tl_set_eq:NN \l__aid_acknowledges_verb_tl \g__aid_str_acknowledges_tl 
          }
          { 
            \tl_set:Nx \l__aid_author_names_tl 
              { 
                \clist_use:Nnnn \g__aid_authors_clist
                  { \ \tl_use:N \g__aid_str_and_tl \space } { ,\space} { ,\ \tl_use:N \g__aid_str_and_tl \space } 
              }
            % Plural forms
            \tl_set_eq:NN \l__aid_declares_verb_tl \g__aid_str_declare_tl 
            \tl_set_eq:NN \l__aid_acknowledges_verb_tl \g__aid_str_acknowledge_tl 
          }
    
        % 3. Prepare Substituted Preamble String
        \tl_set_eq:NN \l__aid_working_preamble_tl \g__aid_str_preamble_tl
    
        % Perform replacements
        \tl_replace_all:Nnn \l__aid_working_preamble_tl { <AUTHOR> } { \l__aid_author_names_tl }
        \tl_replace_all:Nnn \l__aid_working_preamble_tl { <DECLARES> } { \l__aid_declares_verb_tl }
        % --- NEW: Replacement for Acknowledges ---
        \tl_replace_all:Nnn \l__aid_working_preamble_tl { <ACKNOWLEDGES> } { \l__aid_acknowledges_verb_tl }

    % 4. Rendering Loop based on Order
    \seq_map_inline:Nn \g__aid_order_seq
      {
        \str_case:nn { ##1 }
          {
            { preamble }
              {
                \__aid_print_preamble:
              }
            { tools }
              {
                \par \bigskip
                \tl_if_empty:NF \g__aid_str_pre_tools_tl
                  { \noindent \tl_use:N \g__aid_str_pre_tools_tl \par \bigskip }
                
                \noindent \textbf { \tl_use:N \g__aid_str_tools_used_tl } \  \tl_use:N \g__aid_tools_sentence_tl
                
                \tl_if_empty:NF \g__aid_str_post_tools_tl
                  { \par \bigskip \noindent \tl_use:N \g__aid_str_post_tools_tl }
              }
            { taxonomy }
              {
                \par \bigskip
                \tl_if_empty:NF \g__aid_str_pre_taxonomy_tl
                  { \tl_use:N \g__aid_str_pre_taxonomy_tl }
                
                \group_begin:
                  \cs_set:Npn \baselinestretch { 1.1 }
                  \selectfont
                  \tl_use:N \g__aid_fontsize_tl
                  \cs_set:Npn \TGroup ####1 ####2
                    {
                      \par \bigskip
                      \int_compare:nNnTF { #2 } < { 2 }
                        {
                          \textbf{ \larger ####1 \  \hrulefill}\par\nopagebreak[4]
                          \begin{ aidlist }
                            ####2
                          \end{ aidlist }
                        }
                        {
                          \setlength { \multicolsep } { 4pt } 
                          \begin { multicols } { #2 } [ \noindent \textbf { \larger ####1 \  \hrulefill } ]
                            \begin { aidlist }
                              ####2
                            \end { aidlist }
                          \end { multicols }
                        }
                    }
                  \cs_set:Npn \TItem ####1 ####2
                    {
                      % Check if key is active to determine box type AND text color
                      \seq_if_in:NxTF \g__aid_active_keys_seq { \tl_to_str:n { ####1 } }
                        {
                           \item [ \__aid_print_checked_box: ]
                           \group_begin:
                           \color{ \g__aid_color_used_tl }
                           \parbox[t]{\linewidth}{ \raggedright ####2 }
                           \group_end:
                        }
                        {
                           \item [ \__aid_print_empty_box: ]
                           \group_begin:
                           \color{ \g__aid_color_unused_tl }
                           \parbox[t]{\linewidth}{ \raggedright ####2 }
                           \group_end:
                        }
                    }
                  \cs_set_eq:NN \TSubItem \TItem
                  \tl_use:N \g__aid_taxonomy_tl
                \group_end:
                
                \tl_if_empty:NF \g__aid_str_post_taxonomy_tl
                  { \par \bigskip \noindent \tl_use:N \g__aid_str_post_taxonomy_tl }
              }
            { comments }
              {
                \tl_if_empty:NF \g__aid_comments_tl
                  {
                    \par \bigskip
                    \tl_if_empty:NF \g__aid_str_pre_comments_tl
                      { \noindent \tl_use:N \g__aid_str_pre_comments_tl \par \bigskip }
                      
                    \tl_use:N \g__aid_comments_tl
                    
                    \tl_if_empty:NF \g__aid_str_post_comments_tl
                      { \par \bigskip \noindent \tl_use:N \g__aid_str_post_comments_tl }
                  }
              }
          }
      }
  }

% =========================================================
% 8) BIBLIOGRAPHY HANDLING
% =========================================================

\cs_new_protected:Nn \__aidisclose_write_bib_file:n
  {
    \iow_new:N \l__aidisclose_bib_iow
    \iow_open:Nn \l__aidisclose_bib_iow { #1 }
    \iow_now:Nn \l__aidisclose_bib_iow 
      {
@article{Suchikova:2025:AIDDeT,^^J
~~title~~~~~=~{{AIDDeT~(Generative~AI~Delegation~Taxonomy)}:~A~Taxonomy~for~Humans~to~Delegate~Tasks~to~Generative~Artificial~Intelligence~in~Scientific~Research~and~Publishing},^^J
~~author~~~~=~{Yana~Suchikova~and~Natalia~Tsybuliak~and~Jaime~A.~Teixeira~da~Silva~and~Serhii~Nazarovets},^^J
~~year~~~~~~=~2025,^^J
~~journal~~~=~{Accountability~in~Research},^^J
~~publisher~=~{Taylor~\&~Francis},^^J
~~pages~~~~~=~{1--27},^^J
~~doi~~~~~~~=~{10.1080/08989621.2025.2544331}^^J
}^^J
^^J
@manual{Lourenco:2025:aidisclose,^^J
~~author~~~~=~{Lourenço,~João~M.},^^J
~~title~~~~~=~{The~\texttt{aidisclose}~package:~Generative~AI~disclosure~checklist~and~statements},^^J
~~year~~~~~~=~{2025},^^J
~~note~~~~~~=~{Version~\aidversion},^^J
~~url~~~~~~~=~{https://ctan.org/pkg/aidisclose/aidisclose-doc.pdf}^^J
}^^J
^^J
@misc{latex-project,^^J
~~title~~~~~=~{\LaTeX{}~–~A~document~preparation~system},^^J
~~author~~~~=~{{The~\LaTeX{}~Project~team}},^^J
~~year~~~~~~=~{1985},^^J
~~url~~~~~~~=~{https://www.latex-project.org},^^J
}^^J
      }
    \iow_close:N \l__aidisclose_bib_iow
  }

\AddToHook {begindocument/before} {
  \__aid_detect_and_load_language:
  
  \bool_if:NT \g__aid_autobib_bool
    {
      \__aidisclose_write_bib_file:n { \str_use:N \g__aid_bibfile_str }
      \@ifpackageloaded { biblatex }
        { \addbibresource { \str_use:N \g__aid_bibfile_str } }
        { 
          \cs_set_eq:NN \__aidisclose_orig_bibliography:n \bibliography
          \RenewDocumentCommand \bibliography { m }
            { \__aidisclose_orig_bibliography:n { aidisclose , #1 } }
        }
    }
    \AIDtoolsUsed { }
}

\endinput